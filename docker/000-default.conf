<VirtualHost *:80>
  ServerAdmin datapunt@amsterdam.nl
  DocumentRoot /srv/mapserver

  ## X-forwarded-For must be present in production otherwise we cant determine the access scope
  #<If "-z ${LOCAL}">
    #RewriteEngine On
    #RewriteCond %{HTTP:X-Forwarded-For} ^$
    #RewriteRule ^ - [F]
  #</If>

  # Allow private access for clients on internal networks and dev environments
  SetEnv MS_MAP_PATTERN "\/srv\/mapserver\/[^/]+\.map"
  SetEnvIfExpr "-n reqenv('LOCAL') || req('X-Forwarded-For') -ipmatch '10.0.0.0/8' || req('X-Forwarded-For') -ipmatch '172.16.0.0/12' || req('X-forwarded-For') -ipmatch '192.168.0.0/16'" MS_MAP_PATTERN="\/srv\/mapserver\/[^/]+\.map|\/srv\/mapserver\/private\/[^/]+\.map"

  ErrorLog /dev/stdout
  CustomLog /dev/stdout combined

  <Directory /srv/mapserver>
      Require all denied
      <FilesMatch "\.(xml|map|sld|png|json)$">
          Require all granted
      </FilesMatch>
  </Directory>

  Alias /sld /srv/mapserver/sld
  Alias /legend /srv/mapserver/symbols/legend

  RewriteEngine On
  RewriteCond %{REQUEST_METHOD} OPTIONS
  RewriteRule ^(.*)$ $1 [R=200,L]

  RewriteEngine On
  RewriteCond %{REQUEST_URI} /maps/(blackspots|brandkranen)
  RewriteRule /maps/(.+) /cgi-bin/mapserv?map=/srv/mapserver/private/$1.map    [QSA,PT]

  RewriteEngine On
  RewriteCond %{REQUEST_URI} !^/maps/private
  RewriteRule /maps/(.+) /cgi-bin/mapserv?map=/srv/mapserver/$1.map    [QSA,PT]

  ScriptAlias /cgi-bin/ /usr/lib/cgi-bin/
  <Directory "/usr/lib/cgi-bin">
    AllowOverride None
    Options +ExecCGI -MultiViews +SymLinksIfOwnerMatch
    Require all granted
  </Directory>
  RewriteCond %{REQUEST_URI} ^/$
  Rewriterule ^(.*)$ https://api.data.amsterdam.nl/api/ [L,R=301]

  Header always set Access-Control-Allow-Methods "POST, GET, OPTIONS"
  Header always set Access-Control-Allow-Headers "Authorization, kbn-version, Origin, X-Requested-With, Content-Type, Accept, Client-Security-Token"

</VirtualHost>
